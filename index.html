<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="mask">
    <div class="loader">Подождите, пожалуйста, комментарии загружаются</div>
  </div>
  <div class="container">
    <ul class="comments" id="comments">
      <!-- список рендерится из JS -->
    </ul>
    <div class="mask-comment">
      <div class="loader-comment">Комментарий загружается...</div>
    </div>
    <div class="add-form">
      <input type="text" class="add-form-name" id="add-form-name" placeholder="Введите ваше имя" value="" />
      <textarea type="textarea" class="add-form-text" id="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        aria-valuetext=""></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-form-button">Написать</button>
      </div>
    </div>
    <div class="add-form-row">
      <button class="add-form-button delete" id="del-form-button">Удалить последний комментарий</button>
    </div>
  </div>

</body>

<script>
  "use strict";
  const addFormButtonElement = document.getElementById("add-form-button");
  const addFormTextElement = document.getElementById("add-form-text");
  const addFormNameElement = document.getElementById("add-form-name");
  const commentsListElements = document.getElementById("comments");

  const editCommentsButton = document.querySelectorAll(".add-form-button.edit");
  const addForm = document.querySelector(".add-form");
  const commentsList = document.querySelectorAll(".comments");
  const commentElement = document.querySelectorAll(".comment");
  const likesButtonElement = document.querySelectorAll(".like-button");
  const likesCounterElement = document.querySelectorAll(".likes-counter");
  const boxTextComment = document.querySelectorAll(".comment-body");
  const dateCommentElement = document.querySelectorAll(".date");
  const addLoader = document.querySelector(".mask");
  const addLoaderComment = document.querySelector(".mask-comment");

  let commentsListData = [];

  addLoaderComment.style.display = 'none';
  addLoader.style.display = 'block';
  document.body.style.overflow = 'hidden';

  const doFetchGetCommentList = () => {
    fetch('https://wedev-api.sky.pro/api/v1/inna-serebriakova/comments', {
      method: "GET",
    })
      .then((response) => {
        return response.json()
      })
      .then((responseData) => {
        commentsListData = responseData.comments.map((comment) => {
          comment.date = getCurrentDate(comment.date);
          return {
            name: comment.author.name,
            date: comment.date,
            comment: comment.text,
            like: comment.likes,
            isLike: false,
          }
        });
        renderCommentsList();
        addLoader.style.display = 'none';
        document.body.style.overflow = 'visible';
      });
  };

  doFetchGetCommentList();

  const getCurrentDate = (currentDate) => {
    currentDate = new Date(currentDate);
    let date = currentDate.getDate();
    let montch = currentDate.getMonth();
    let year = currentDate.getFullYear();
    let hours = currentDate.getHours();
    let minute = currentDate.getMinutes();

    if (date < 10) {
      date = "0" + date;
    }
    if (montch < 10) {
      montch = "0" + montch;
    }
    if (hours < 10) {
      hours = "0" + hours;
    }
    if (minute < 10) {
      minute = "0" + minute;
    }
    const yearForm = toString(year).split('').push([2], [3]);
    const comDate = date + "." + montch + "." + yearForm + " " + hours + ":" + minute;
    return comDate;
  }

  const initEventListener = () => {
    likesCounterElement.value = 0;
    const likesButtonElement = document.querySelectorAll(".like-button");
    for (const likeButtonElement of likesButtonElement) {
      likeButtonElement.addEventListener("click", (event) => {
        event.stopPropagation();

        const index = likeButtonElement.dataset.index;

        if (commentsListData[index].isLike === false) {
          commentsListData[index].isLike = true;
          commentsListData[index].like++;
        } else {
          commentsListData[index].isLike = false;
          commentsListData[index].like--;
        }
        renderCommentsList()
      })
    }
  };

  const answerCommentListener = () => {
    const commentsElement = document.querySelectorAll(".comment");
    for (const commentElement of commentsElement) {
      commentElement.addEventListener("click", () => {

        const index = commentElement.dataset.index;
        const addFormTextElement = document.getElementById("add-form-text");
        const boxTextComment = document.querySelectorAll(".comment-body");

        addFormTextElement.value =
          `QUOTE_BEGIN ${commentsListData[index].name}: 
          ${commentsListData[index].comment} QUOTE_END`;

        renderCommentsList();
      })
    }
  };

  const delLastComment = () => {
    const delCommentButton = document.getElementById("del-form-button");
    delCommentButton.addEventListener("click", () => {
      commentsListData.pop();

      renderCommentsList();
    });
  }

  const editComment = () => {
    const editCommentsButton = document.querySelectorAll(".edit-button");
    const commentsElement = document.querySelectorAll(".comment");

    for (const editCommentButton of editCommentsButton) {
      editCommentButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const boxTextComment = document.querySelectorAll(".comment-body");
        const index = boxTextComment.dataset.index;
        const addFormTextElement = document.getElementById("add-form-text");
        const addFormNameElement = document.getElementById("add-form-name");
        if (commentsListData[index].isEdit === false) {
          commentsListData[index].isEdit = true;
          boxTextComment[index].innerHTML = `<textarea type="textarea" class="add-form-text" id="add-form-text" rows="4"
        aria-valuetext="">${commentsListData[index].comment}</textarea>`;
        } else {
          commentsListData[index].isEdit = false;
          boxTextComment[index].innerHTML = `<div class="${com.isEdit ? 'comment-body -edit' : 'comment-body'}" data-index="${index}>
            <div class="comment-text">
              ${com[index].comment}
            </div>`
        }
        renderCommentsList();
      })
    }
  };

  const renderCommentsList = () => {
    const commentsListHTML = commentsListData.map((com, index) => {
      return `<li class="comment" id="comment" data-index="${index}">
          <div class="comment-header" >
            <div>${com.name}</div>
            <div class="date" date-index="${index}">${com.date}</div>
          </div>
          <div class="${com.isEdit ? 'comment-body -edit' : 'comment-body'}" data-index="${index}>
            <div class="comment-text">
              ${com.comment}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${com.like}</span>
              <button class="${com.isLike ? 'like-button -active-like' : 'like-button'}" data-index="${index}"></button>
            </div>
          </div>
          <div class="edit-button">
            <button class="add-form-button -edit" id="edit-form-button">Редактировать</button>
            <div/>
        </li>`
    })
      .join("");

    commentsListElements.innerHTML = commentsListHTML;

    initEventListener();
    answerCommentListener();
    delLastComment();
    editComment();
    // addByKey();
  };

  addFormNameElement.addEventListener("input", () => {
    console.log("I working")
    if (addFormNameElement.value === "" || addFormTextElement.value === "") {
      addFormButtonElement.disabled = true;
    } else {
      addFormButtonElement.disabled = false;
    }
  })

  addFormTextElement.addEventListener("input", () => {
    console.log("I working")
    if (addFormNameElement.value === "" || addFormTextElement.value === "") {
      addFormButtonElement.disabled = true;
    } else {
      addFormButtonElement.disabled = false;
    }
  })

  const pullComment = () => {
    addFormButtonElement.addEventListener("click", () => {
      const allcomments = commentsListElements.innerHTML;
      addFormButtonElement.style.backgroundColor = "#bcec30";
      addFormNameElement.style.backgroundColor = "";

      doFetchGetCommentList.disabled = true;

      addLoaderComment.style.display = 'block';
      addForm.style.visible = 'hidden';
      document.body.style.overflow = 'hidden';

      fetch('https://wedev-api.sky.pro/api/v1/inna-serebriakova/comments',
        {
          method: "POST",
          body: JSON.stringify({
            text: addFormTextElement.value
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll("&", "&amp;")
              .replaceAll('"', "&quot;")
              .replaceAll("QUOTE_BEGIN", "<div class='quote' white-space: pre-line>")
              .replaceAll("QUOTE_END", "</div>"),
            name: addFormNameElement.value
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll("&", "&amp;")
              .replaceAll('"', "&quot;"),
          })
        })
        .then(() => {
          doFetchGetCommentList()
          addLoaderComment.style.display = 'none';
          document.body.style.overflow = 'visible';
          renderCommentsList();
        })
      addFormNameElement.value = ""
      addFormTextElement.value = ""
      likesCounterElement.value = ""
      renderCommentsList();
    })
  }

  pullComment();
  renderCommentsList();
  console.log(addForm);

  /* const addByKey = () => {
     addForm.addEventListener("keyup", (event) => {
       console.log(event.code);
       if (event.code === "Enter") {
         doFetchPostComment();
       };
       console.log(`sjhfroue`);
     });
   }*/

  console.log("It works!");
</script>

</html>